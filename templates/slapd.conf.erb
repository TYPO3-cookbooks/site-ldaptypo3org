#####
#
# This is a slapd.conf file.  See slapd.conf(5) for more info.
#
# Generated by Chef for <%= node.name %>
#
# $Id:$
####

# TLS configuration
<% if node['openldap']['tls_enabled'] -%>
TLSCertificateFile     <%= node['openldap']['ssl_cert'] %>
TLSCertificateKeyFile  <%= node['openldap']['ssl_key'] %>
<% if node['openldap']['cafile'] -%>
TLSCACertificateFile   <%= node['openldap']['cafile'] %>
<% end -%>
<% end -%>

# Schema and objectClass definitions
<% node['openldap']['schemas'].sort.each do |schema| -%>
include         <%= node['openldap']['dir'] %>/schema/<%= schema %>
<% end -%>

# Where the pid file is put. The init.d script
# will not stop the server if you change this.
pidfile         <%= node['openldap']['run_dir'] %>/slapd.pid

# List of arguments that were passed to the server
argsfile        <%= node['openldap']['run_dir'] %>/slapd.args

# Read slapd.conf(5) for possible values
loglevel        <%= node['openldap']['loglevel'] %>

<% unless node['platform'] == "centos" -%>
# Where the dynamically loaded modules are stored
modulepath	<%= node['openldap']['module_dir'] %>
<% node['openldap']['modules'].sort.each do |mod| -%>
moduleload  <%= mod %>
<% end -%>
<% if node['openldap']['slapd_type'] == "master" -%>
moduleload  syncprov
<% end -%>
<% end -%>

# The maximum number of entries that is returned for a search operation
sizelimit 500

# The tool-threads parameter sets the actual amount of cpu's that is used
# for indexing.
tool-threads 1

#######################################################################
# Specific Backend Directives for hdb:
# Backend specific directives apply to this backend until another
# 'backend' directive occurs
backend		<%= node['openldap']['database'] %>

#####
# Database
#####
database        <%= node['openldap']['database'] %>
suffix          "<%= node['openldap']['basedn'] %>"
rootdn          "cn=<%= node['openldap']['cn'] %>,<%= node['openldap']['basedn'] %>"
rootpw          <%= node['openldap']['rootpw'] %>
directory       "<%= node['openldap']['db_dir'] %>"
lastmod         on

<% if node['openldap']['database'] == 'hdb' -%>
dbconfig set_cachesize 0 31457280 0

# Number of objects that can be locked at the same time.
dbconfig set_lk_max_objects 1500
# Number of locks (both requested and granted)
dbconfig set_lk_max_locks 1500
# Number of lockers
dbconfig set_lk_max_lockers 1500
<% end -%>

##
# Indexes
##
index objectClass eq

<% if node['openldap']['slapd_type'] == "master" -%>
overlay syncprov
syncprov-checkpoint 100 10
syncprov-sessionlog 100
<% end -%>
<% if node['openldap']['slapd_type'] == "slave" -%>
syncrepl rid=<%= node['openldap']['slapd_rid'] %>
  provider=ldap://<%= node['openldap']['slapd_master'] %>:389
  type=refreshAndPersist
  interval=01:00:00:00
  searchbase="<%= node['openldap']['basedn'] %>"
  filter="(objectClass=*)"
  scope=sub
  schemachecking=off
  bindmethod=simple
  binddn="cn=syncrole,<%= node['openldap']['basedn'] %>"
  starttls=yes
  credentials="<%= node['openldap']['slapd_replpw'] %>"
<% end -%>

# todo!
access to * by * read